<html>
<head>
	<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet"></link>
	<script src="/jquery-1.8.3.min.js"></script>
	<script src="/bootstrap/js/bootstrap.min.js"></script>
	<script src="/d3.v3.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="hero-unit"> 
			<h1> WaterFlow </h1>
			<p> 流水 </p>
			<button id="single" class="btn btn-primary btn-large"> single test </button>
			<button id="stress" class="btn btn-primary btn-large"> stress test </button>
			<button id="cleanDB" class="btn btn-primary btn-large"> CleanDB </button>
			<p id="debug"></p>
		</div>
		<table class="table table-condensed">
			<thead>
				<tr>
					<th> Datetime </th>
					<th> Depth </th>
					<th> Lat</th>
					<th> Lon</th>
					<th> Magnitude</th>
					<th> Region</th>
					<th> Operator </th>
				</tr>
			</thead>
			<tbody id="list"> </tbody>
		</table>
	</div>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io.connect('http://box.home:8080');
  var DATACOUNT = 0;
  $("#cleanDB").click(function(){
  	socket.emit("cleanDB", {});
  });
  $("#single").click(function(){
	  console.log("log");
	  socket.emit("log",  { 
	  	Datetime: Date.parse("Sunday, January 13, 2013 18:25:13 UTC"),
	  	Depth: parseFloat("117.00"),
	  	Eqid: "13013005", 
	  	Lat: parseFloat("18.5111"),
	  	Lon: parseFloat("-63.9692"),
	  	Magnitude: parseFloat("2.8") , 
	  	NST: parseInt("5"),
	  	Region: "Virgin Islands region",
	  	Src: "pr",
	  	Version: parseInt("0"),
	  });
  });

  $("#stress").click(function(){
  	d3.csv("/data/eqs7day-M1.csv",
  		function (err, data) {
  			//socket.emit("log",  data[0] );
  			data.forEach(function(d){
  				
  				d.Datetime = Date.parse(d.Datetime);
  				d.Depth = parseFloat(d.Depth);
  				d.Lat = parseFloat(d.Lat);
  				d.Lon = parseFloat(d.Lon);
  				d.Magnitude = parseFloat(d.Magnitude);
  				d.NST = parseInt(d.NST);
  				d.Version = d.Version;
  				
  			})
			var index = 0;
			DATACOUNT = data.length;
			var timer = setInterval( 
				function(){
					socket.emit("log",  data[index] );
					//console.log(data[index]);
					//console.log(index);
					index++;
					if (index >= data.length) {
						clearInterval(timer);
					}
					
				}, 1);
		});
  });
  socket.emit("listready", {});
  socket.emit("count", {})
  socket.on('list', function (data) { 
	  $("tbody#list").html("");
	  table = d3.select("tbody#list");
	  var tr = table.selectAll("tr")
	  		.data(data)
	  		.enter().append("tr");

	  tr.append("td")
	  	.text(function(d){return d.Datetime;});
	  tr.append("td")
	  	.text(function(d){return d.Depth;});
	  tr.append("td")
	  	.text(function(d){return d.Lat;});
	  tr.append("td")
	  	.text(function(d){return d.Lon;});
	  tr.append("td")
	  	.text(function(d){return d.Magnitude;});
	  tr.append("td")
	  	.text(function(d){return d.Region;});

	  tr.append("td")
	  	.append("i")
	  	.on("click", function(d){
	  		console.log(d._id);
	  		socket.emit("delRec", d._id);
	  	})
	  	.attr("class", "icon-remove");
	  
	  setTimeout(function(){
		  console.log("listready");
		  socket.emit("listready", {})
	  }, 10000);
  });
  socket.on('countReady', function (data) { 
  	$("#debug").text("total num " + data + " / " + DATACOUNT);
  	setTimeout(function(){
		  socket.emit("count", {})
	  }, 1000);
  });
</script>
</html>
